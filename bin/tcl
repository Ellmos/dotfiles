#!/bin/sh

if [ $# -lt 1 ]; then
    echo "Tiger file needed"
    exit 1
fi

RED="\033[1;31m"
GREEN="\033[1;32m"
BLUE="\033[1;34m"
PURPLE='\033[1;95m'  
STOP="\e[0m"

print()
{
    echo -e "$1"
}

TEST_OUT=".student.test-log"
FILE_PATH=$1
opt="--llvm-runtime-display --llvm-display"
OUTPUT_FILE="/tmp/test_code.ll"
BIN="main.out"

~/miau-rawr/src/tc $opt "$FILE_PATH" > "$OUTPUT_FILE" 2> ".stderr$TEST_OUT"
test_status=$?
if [ $test_status -ne 0 ]; then
    print "[${BLUE}LLVM${STOP}][${PURPLE}TC${STOP}][${RED}FAIL${STOP}] failed to translate to llvm"
    exit 1
fi

clang32 -m32 "$OUTPUT_FILE" -o "$BIN" > /dev/null 2> /dev/null
test_status=$?
if [ $test_status -ne 0 ]; then
    print "[${BLUE}LLVM${STOP}][${PURPLE}CLANG${STOP}][${RED}FAIL${STOP}] failed to clang"
    exit 1
fi

./main.out > /dev/null
test_status=$?
if [ $test_status -ne 0 ]; then
    print "[${BLUE}LLVM${STOP}][${PURPLE}EXEC${STOP}][${RED}FAIL${STOP}] bad return code"
    exit 1
fi
