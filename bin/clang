#!/nix/store/6payx2da66dbjl6vg15csxfb5hpf3df4-bash-5.2-p15/bin/bash
# This script checks a git repository has a clang-format configuration and runs
# clang-format with the given parameters.

error() {
    printf "\033[0;31m${@}\033[0m\n"
    exit 1
}


repo="$(/nix/store/a6kkk753yryjb7ma9bsbzkgbcg9l2900-git-2.42.0/bin/git rev-parse --show-toplevel 2>/dev/null)"

if test "$?" -ne 0; then
    error "You must run this script from the work tree of a git repository"
fi

clang_format_file="${repo}/.clang-format"

if ! test -f "${clang_format_file}"; then
    error "Failed to find clang-format configuration at ${clang_format_file}"
fi

if [ "$#" -eq 0 ]; then
    echo "No parameter given, running clang-format in whole repo"
    /nix/store/kkdpismvz265v32f1sh2pj389ccz063k-findutils-4.9.0/bin/find "$repo" -type f -regex '.*\.\(c\|h\|cc\|hh\|hxx\)' -exec /nix/store/qz1f9rs2pra85yd6sj462agkvkf5yl7r-clang-tools-14.0.6/bin/clang-format --style=file -i {} ';'
    exit;
fi


for folder; do
    /nix/store/kkdpismvz265v32f1sh2pj389ccz063k-findutils-4.9.0/bin/find "$folder" -type f -regex '.*\.\(c\|h\|cc\|hh\|hxx\)' -exec /nix/store/qz1f9rs2pra85yd6sj462agkvkf5yl7r-clang-tools-14.0.6/bin/clang-format --style=file -i {} ';'
done
